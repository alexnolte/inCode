<!DOCTYPE HTML>
<html><head><title>Type-safe Tic Tac Toe (Part 1) · in Code</title><meta name="description" content="Weblog of Justin Le, covering various adventures in programming and explorations in the vast worlds of computation physics, and knowledge."><meta http-equiv="Content-Type" content="text/html;charset=utf-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><meta name="flattr:id" content="3p9jqr"><meta property="og:site_name" content="in Code"><meta property="og:description" content="One problem with adoption of dependent types in everyday programming, I think, is that most examples out there are sort of small and self-contained. There aren’t too many larger-scale examples out there showing how dependent types can permeate your whole program to make everything more robust and error-free. So, this series will be implementing a type-safe tic tac toe game (a medium-scale Haskell app) that can be played both on the console (using Haskeline) and in the browser (using Miso), using some custom built AI. We will:  * Build up our core game engine, talking about what it really means to be type safe * Use our type-safe engine to build type-safe controllers (AI, GUI) This series will also be a mini-tutorial on the decidable package that I just recently released :) We will also be heavily using the singletons library. Where relevant, I will explain singletons concepts in brief. If you want a more in-depth introduction to the singletons library, however, check out my Introduction to Singletons series!"><meta property="og:type" content="article"><meta property="og:title" content="Type-safe Tic Tac Toe (Part 1)"><meta property="og:image" content="https://blog.jle.im/img/site_logo.jpg"><meta property="og:locale" content="en_US"><meta property="og:url" content="https://blog.jle.im/entry/typesafe-tic-tac-toe-1.html"><meta name="twitter:card" content="summary"><meta name="twitter:creator:id" content="mstk"><link rel="author" href="https://plus.google.com/107705320197444500140"><link rel="alternate" type="application/rss+xml" title="in Code (RSS Feed)" href="http://feeds.feedburner.com/incodeblog"><link rel="canonical" href="https://blog.jle.im/entry/typesafe-tic-tac-toe-1.html"><link href="https://blog.jle.im/favicon.ico" rel="shortcut icon"><link href="https://blog.jle.im/css/toast.css" rel="stylesheet" type="text/css"><link href="https://blog.jle.im/css/font.css" rel="stylesheet" type="text/css"><link href="https://blog.jle.im/css/main.css" rel="stylesheet" type="text/css"><link href="https://blog.jle.im/css/page/entry.css" rel="stylesheet" type="text/css"><link href="https://blog.jle.im/css/pygments.css" rel="stylesheet" type="text/css"><script type="text/javascript">var page_data = {};
var disqus_shortname='incode';
</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-443711-8', 'jle.im');
ga('send', 'pageview');
</script><script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5234d67a6b68dcd4"></script><script type="text/javascript" src="https://blog.jle.im/js/page/entry_toc.js"></script><script type="text/javascript" src="https://blog.jle.im/js/disqus_count.js"></script><script type="text/javascript" src="https://blog.jle.im/js/social.js"></script><script type="text/javascript" src="https://blog.jle.im/js/jquery/jquery.toc.js"></script><script type="text/javascript" src="https://blog.jle.im/purescript/entry.js"></script></head><body><div id="fb-root"><script>(function(d, s, id) {
 var js, fjs = d.getElementsByTagName(s)[0];
 if (d.getElementById(id)) return;
 js = d.createElement(s); js.id = id;
 js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=641852699171929";
 fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));
</script></div><div id="header-container"><div id="navbar-container" class="tile"><nav id="navbar-content"><div class="nav-info"><h1 class="site-title"><a href="https://blog.jle.im/" class="nav-title">in Code</a></h1><span class="nav-author">Justin Le</span></div><ul class="nav-links"><li><a href="https://blog.jle.im/">home</a></li><li><a href="https://blog.jle.im/entries.html">archives</a></li><div class="clear"></div></ul></nav></div><div id="header-content"></div></div><div id="body-container" class="container"><div id="main-container" class="grid"><div class="entry-section unit span-grid" role="main"><article class="tile article"><header><div class="unposted-banner">Unposted entry</div><h1 id="title">Type-safe Tic Tac Toe (Part 1)</h1><p class="entry-info">by <a class="author" href="https://blog.jle.im/">Justin Le</a></p><p><span class="source-info"><a class="source-link" href="https://github.com/mstksg/inCode/tree/master/copy/entries/ttt-1.md">Source</a><span class="info-separator"> &diams; </span><a class="source-link" href="https://github.com/mstksg/inCode/tree/gh-pages/entry/typesafe-tic-tac-toe-1.md">Markdown</a><span class="info-separator"> &diams; </span><a class="source-link" href="https://blog.jle.im/entry/typesafe-tic-tac-toe-1.tex">LaTeX</a><span class="info-separator"> &diams; </span></span>Posted in <a href="https://blog.jle.im/entries/category/@haskell.html" class="tag-a-category" title="Functional, pure, non-strict, statically and strongly typed, natively
compiled...really just the king of great languages.">Haskell</a><span class="info-separator"> &diams; </span><a class="comment-link" href="#disqus_thread">Comments</a></p></header><hr><aside class="contents-container"><h5 id="contents-header">Contents</h5><div id="toc"></div></aside><div class="main-content copy-content"><p>One problem with adoption of dependent types in everyday programming, I think, is that most examples out there are sort of small and self-contained. There aren’t <em>too</em> many larger-scale examples out there showing how dependent types can permeate your whole program to make everything more robust and error-free.</p>
<p>So, this series will be implementing a type-safe <em>tic tac toe</em> game (a medium-scale Haskell app) that can be played both on the console (using Haskeline) and in the browser (using Miso), using some custom built AI. We will:</p>
<ol type="1">
<li>Build up our core game engine, talking about what it really means to be type safe</li>
<li>Use our type-safe engine to build type-safe controllers (AI, GUI)</li>
</ol>
<p>This series will also be a mini-tutorial on the <em><a href="https://hackage.haskell.org/package/decidable">decidable</a></em> package that I just recently released :) We will also be heavily using the <em><a href="https://hackage.haskell.org/package/singletons">singletons</a></em> library. Where relevant, I will explain singletons concepts in brief. If you want a more in-depth introduction to the <em>singletons</em> library, however, check out my <a href="https://blog.jle.im/entries/series/+introduction-to-singletons.html">Introduction to Singletons</a> series!</p>
<h2 id="type-safety">Type-Safety</h2>
<p>First off, we should ask the question: what does it mean to be type-safe?</p>
<p>?????</p>
<h2 id="the-specification">The Specification</h2>
<p>We’re going to create a type that represents a <em>valid</em> game state. The goal is to make a GADT where you can only construct values whose types represent <em>valid</em> game states. If we have a value of this type, then we know that the game state must be valid.</p>
<p>A good way to start with this is by thinking of <em>induction rules</em> for defining a valid state.</p>
<p>We’ll say that there are two parts of a game state:</p>
<ol type="1">
<li>The current board</li>
<li>The current player</li>
</ol>
<p>and that there are two ways of “constructing” a valid state:</p>
<ol type="1">
<li>The empty board with player X is a valid state.</li>
<li><p>If we have:</p>
<ul>
<li>A valid state with board <em>b</em> and current player <em>p</em></li>
<li>The game is still in play</li>
<li>We can add a valid move by player <em>p</em> to board <em>b</em></li>
</ul>
<p>Then the result of this move represents a new valid board <em>b</em>, with swapped player <em>p</em>.</p></li>
</ol>
<p>This is a denotative way to talk about what it means for a state to be valid.</p>
<p>Note that our “type safety” is only as strong as the specification we just wrote. Type safety using dependent types isn’t omnipotent, and it can’t read your mind. However, there is a nice assurance that as long as your <em>specification</em> is right, your program will work as expected. And hey, it’s a step up from the untyped case, where you can have a specification wrong, but implement it incorrectly. With “type-safety”, you cut out one huge area where bugs come from: the implementation.</p>
<p>Alright, let’s do this!</p>
<h2 id="valid-state">Valid State</h2>
<p>First, we’ll define the types we need to specify our state:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="fu">$</span>(singletons [d|</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">-- source: https://github.com/mstksg/inCode/tree/master/code-samples/ttt/Part1.hs#L38-L53</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1-4" data-line-number="4">  data Piece = PX | PO</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">    deriving (Eq, Ord)</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">  </a>
<a class="sourceLine" id="cb1-7" data-line-number="7">  type Board = [[Maybe Piece]]</a>
<a class="sourceLine" id="cb1-8" data-line-number="8"></a>
<a class="sourceLine" id="cb1-9" data-line-number="9">  emptyBoard :: Board</a>
<a class="sourceLine" id="cb1-10" data-line-number="10">  emptyBoard = [[Nothing, Nothing, Nothing]</a>
<a class="sourceLine" id="cb1-11" data-line-number="11">               ,[Nothing, Nothing, Nothing]</a>
<a class="sourceLine" id="cb1-12" data-line-number="12">               ,[Nothing, Nothing, Nothing]</a>
<a class="sourceLine" id="cb1-13" data-line-number="13">               ]</a>
<a class="sourceLine" id="cb1-14" data-line-number="14"></a>
<a class="sourceLine" id="cb1-15" data-line-number="15">  altP :: Piece -&gt; Piece</a>
<a class="sourceLine" id="cb1-16" data-line-number="16">  altP PX = PO</a>
<a class="sourceLine" id="cb1-17" data-line-number="17">  altP PO = PX</a>
<a class="sourceLine" id="cb1-18" data-line-number="18"></a>
<a class="sourceLine" id="cb1-19" data-line-number="19">  |])</a>
<a class="sourceLine" id="cb1-20" data-line-number="20"></a>
<a class="sourceLine" id="cb1-21" data-line-number="21">  <span class="kw">type</span> <span class="dt">Board</span> <span class="fu">=</span> [[<span class="dt">Maybe</span> <span class="dt">Piece</span>]]</a>
<a class="sourceLine" id="cb1-22" data-line-number="22"></a>
<a class="sourceLine" id="cb1-23" data-line-number="23"><span class="ot">  emptyBoard ::</span> <span class="dt">Board</span></a>
<a class="sourceLine" id="cb1-24" data-line-number="24">  emptyBoard <span class="fu">=</span> [[<span class="dt">Nothing</span>, <span class="dt">Nothing</span>, <span class="dt">Nothing</span>]</a>
<a class="sourceLine" id="cb1-25" data-line-number="25">               ,[<span class="dt">Nothing</span>, <span class="dt">Nothing</span>, <span class="dt">Nothing</span>]</a>
<a class="sourceLine" id="cb1-26" data-line-number="26">               ,[<span class="dt">Nothing</span>, <span class="dt">Nothing</span>, <span class="dt">Nothing</span>]</a>
<a class="sourceLine" id="cb1-27" data-line-number="27">               ]</a>
<a class="sourceLine" id="cb1-28" data-line-number="28"></a>
<a class="sourceLine" id="cb1-29" data-line-number="29"><span class="ot">  altP ::</span> <span class="dt">Piece</span> <span class="ot">-&gt;</span> <span class="dt">Piece</span></a>
<a class="sourceLine" id="cb1-30" data-line-number="30">  altP <span class="dt">PX</span> <span class="fu">=</span> <span class="dt">PO</span></a>
<a class="sourceLine" id="cb1-31" data-line-number="31">  altP <span class="dt">PO</span> <span class="fu">=</span> <span class="dt">PX</span></a>
<a class="sourceLine" id="cb1-32" data-line-number="32"></a>
<a class="sourceLine" id="cb1-33" data-line-number="33">  <span class="fu">|</span>])</a>
<a class="sourceLine" id="cb1-34" data-line-number="34">  <span class="fu">|</span>])</a></code></pre></div>
<p>A <code>Piece</code> will also represent our player – either <code>PX</code> or <code>PO</code>. Our <code>Board</code> will be a list of lists of <code>Maybe Piece</code>. If the spot contains <code>Nothing</code>, the spot is unplayed; if the spot is <code>Just p</code>, then it means the spot has been played by <code>p</code>.</p>
<p>And some values and functions we need to talk about empty boards and state transformations:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="fu">$</span>(singletons [d|</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">-- source: https://github.com/mstksg/inCode/tree/master/code-samples/ttt/Part1.hs#L43-L53</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"></a>
<a class="sourceLine" id="cb2-4" data-line-number="4">  emptyBoard :: Board</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">  emptyBoard = [[Nothing, Nothing, Nothing]</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">               ,[Nothing, Nothing, Nothing]</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">               ,[Nothing, Nothing, Nothing]</a>
<a class="sourceLine" id="cb2-8" data-line-number="8">               ]</a>
<a class="sourceLine" id="cb2-9" data-line-number="9"></a>
<a class="sourceLine" id="cb2-10" data-line-number="10">  altP :: Piece -&gt; Piece</a>
<a class="sourceLine" id="cb2-11" data-line-number="11">  altP PX = PO</a>
<a class="sourceLine" id="cb2-12" data-line-number="12">  altP PO = PX</a>
<a class="sourceLine" id="cb2-13" data-line-number="13"></a>
<a class="sourceLine" id="cb2-14" data-line-number="14">  |])</a>
<a class="sourceLine" id="cb2-15" data-line-number="15"></a>
<a class="sourceLine" id="cb2-16" data-line-number="16"><span class="ot">  altP ::</span> <span class="dt">Piece</span> <span class="ot">-&gt;</span> <span class="dt">Piece</span></a>
<a class="sourceLine" id="cb2-17" data-line-number="17">  altP <span class="dt">PX</span> <span class="fu">=</span> <span class="dt">PO</span></a>
<a class="sourceLine" id="cb2-18" data-line-number="18">  altP <span class="dt">PO</span> <span class="fu">=</span> <span class="dt">PX</span></a>
<a class="sourceLine" id="cb2-19" data-line-number="19"></a>
<a class="sourceLine" id="cb2-20" data-line-number="20">  <span class="fu">|</span>])</a>
<a class="sourceLine" id="cb2-21" data-line-number="21">  <span class="fu">|</span>])</a></code></pre></div>
<p>Let’s just throw in a quick proof as a sanity check:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="co">-- source: https://github.com/mstksg/inCode/tree/master/code-samples/ttt/Part1.hs#L63-L65</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="ot">altP_cyclic ::</span> <span class="dt">Sing</span> p <span class="ot">-&gt;</span> <span class="dt">AltP</span> (<span class="dt">AltP</span> p) <span class="fu">:~:</span> p</a>
<a class="sourceLine" id="cb3-4" data-line-number="4">altP_cyclic <span class="dt">SPX</span> <span class="fu">=</span> <span class="dt">Refl</span> <span class="fu">@</span>&#39;<span class="dt">PX</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5">altP_cyclic <span class="dt">SPO</span> <span class="fu">=</span> <span class="dt">Refl</span> <span class="fu">@</span>&#39;<span class="dt">PO</span></a></code></pre></div>
<p>With that in mind, we can write our valid state constructor. We’ll do that with two helper types that we will implement later. First, we’ll use the <a href="https://hackage.haskell.org/package/decidable">decidable</a> library to talk about the kind of a <em>type-level predicate</em>.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">data</span> <span class="dt">InPlay</span><span class="ot"> ::</span> <span class="dt">Predicate</span> <span class="dt">Board</span></a></code></pre></div>
<p><code>InPlay</code> is a predicate that a given board is in-play; a value of type <code>InPlay @@ b</code> is a witness or proof that a board is in play.</p>
<p>We also need to define a type for a valid update by a given player onto a given board:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">data</span> <span class="dt">Update</span><span class="ot"> ::</span> <span class="dt">Piece</span> <span class="ot">-&gt;</span> <span class="dt">Board</span> <span class="ot">-&gt;</span> <span class="dt">Board</span> <span class="ot">-&gt;</span> <span class="dt">Type</span></a></code></pre></div>
<p>A value of type <code>Update p b1 b2</code> will represent a valid update to board <code>b1</code> by player <code>p</code> to create a board <code>b2</code>.</p>
<p>And finally, our valid state constructor:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">data</span> <span class="dt">GameState</span><span class="ot"> ::</span> <span class="dt">Piece</span> <span class="ot">-&gt;</span> <span class="dt">Board</span> <span class="ot">-&gt;</span> <span class="dt">Type</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">    <span class="co">-- | The empty board is a valid state</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3">    <span class="dt">GSStart</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="ot">        ::</span> <span class="dt">GameState</span> &#39;<span class="dt">PX</span> <span class="dt">EmptyBoard</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5">    <span class="co">-- | We can also construct a valid game state if we have:</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6">    <span class="dt">GSUpdate</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7"><span class="ot">        ::</span> forall p b1 b2<span class="fu">.</span> ()</a>
<a class="sourceLine" id="cb6-8" data-line-number="8">        <span class="ot">=&gt;</span> <span class="dt">InPlay</span>          <span class="fu">@@</span> b1     <span class="co">-- ^ a proof that b1 is in play</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9">        <span class="ot">-&gt;</span> <span class="dt">Update</span>    p        b1 b2  <span class="co">-- ^ a valid update</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10">        <span class="ot">-&gt;</span> <span class="dt">GameState</span> p        b1     <span class="co">-- ^ a proof that p, b1 are a valid state</span></a>
<a class="sourceLine" id="cb6-11" data-line-number="11">        <span class="co">-- ---------------------------- then</span></a>
<a class="sourceLine" id="cb6-12" data-line-number="12">        <span class="ot">-&gt;</span> <span class="dt">GameState</span> (<span class="dt">AltP</span> p)    b2  <span class="co">-- ^ AltP p, b2 is a valid satte</span></a></code></pre></div>
<p>And that’s it — a verified-correct representation of a game state, directly transcribed from our plain-language denotative specification.</p>
<p>Now we just need to talk about <code>InPlay</code> and <code>Update</code>. In particular, we need:</p>
<ol type="1">
<li>A definition of <code>Update</code>, and a way to turn user-input into a valid <code>Update</code> (or reject it if it isn’t valid).</li>
<li>A definition of <code>InPlay</code>, and a way to decide whether or not a given board <code>b</code> is <code>InPlay</code>. This is something that the appropriately named <em><a href="https://hackage.haskell.org/package/decidable">decidable</a></em> library will help us with.</li>
</ol>
<h2 id="update">Update</h2>
<p>Let’s go about what thinking about what defines a valid update. Remember, the kind we wanted was:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">data</span> <span class="dt">Update</span><span class="ot"> ::</span> <span class="dt">Piece</span> <span class="ot">-&gt;</span> <span class="dt">Board</span> <span class="ot">-&gt;</span> <span class="dt">Board</span> <span class="ot">-&gt;</span> <span class="dt">Type</span></a></code></pre></div>
<p>An <code>Update p b1 b2</code> will be a valid update of <code>b1</code> by player <code>p</code> to produce <code>b2</code>. So, we need to:</p>
<ol type="1">
<li>Produce <code>b2</code> from <code>b1</code></li>
<li>Be sure that the move is valid — namely, that it is placed in a clean spot so that it doesn’t overwrite any previous moves.</li>
</ol>
<p>Producing <code>b2</code> from <code>b1</code> is simple enough as a type family. In fact, we can just use the <em><a href="https://hackage.haskell.org/package/lens-typelevel">lens-typelevel</a></em> library to update our nested list:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="fu">$</span>(singletonsOnly [d|</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">  placeBoard :: N -&gt; N -&gt; Piece -&gt; Board -&gt; Board</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">  placeBoard i j p = set (ixList i . ixList j) (Just p)</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">  |])</a></code></pre></div>
<p>This is just lenses — <code>set l x</code> is a function that sets the field specified by <code>l</code> to <code>x</code>. Here, we set the jth item of the ith list to be <code>Just p</code>. That means we can now produce <code>b2</code> from <code>b1</code> – it’s just <code>PlaceBoard i j p b1</code>.</p>
<p>Here, <code>N</code> is the peano nat type (a lot of libraries define it, but it’s also defined as a uility in <em>lens-typelevel</em>). It’s essentially <code>[()]</code> (which makes it useful as an index type), or:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">data</span> <span class="dt">N</span> <span class="fu">=</span> <span class="dt">Z</span> <span class="fu">|</span> <span class="dt">S</span> <span class="dt">N</span></a></code></pre></div>
<p>A natural number is either zero, or the successor of another natural number. <code>S (S Z)</code>, for example, would represent 2.</p>
<p>The trickier part is making sure that the spot at <em>(i, j)</em> isn’t already taken. For that, we’ll introduce a common helper type to say <em>what</em> the piece at spot <em>(i, j)</em> is:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw">data</span> <span class="dt">Coord</span><span class="ot"> ::</span> (<span class="dt">N</span>, <span class="dt">N</span>) <span class="ot">-&gt;</span> [[k]] <span class="ot">-&gt;</span> k <span class="ot">-&gt;</span> <span class="dt">Type</span></a></code></pre></div>
<p>A <code>Coord '(i, j) xss x</code> is a data type that specifies that the jth item in the ith list in <code>b</code> is <code>p</code>.</p>
<p>And we require <code>Update</code> to only be constructable if the spot at <em>(i, j)</em> is <code>Nothing</code>:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw">data</span> <span class="dt">Update</span><span class="ot"> ::</span> <span class="dt">Piece</span> <span class="ot">-&gt;</span> <span class="dt">Board</span> <span class="ot">-&gt;</span> <span class="dt">Board</span> <span class="ot">-&gt;</span> <span class="dt">Type</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">    <span class="dt">MkUpdate</span><span class="ot"> ::</span> forall i j p b<span class="fu">.</span> ()</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">             <span class="ot">=&gt;</span> <span class="dt">Coord</span> &#39;(i, j) b &#39;<span class="dt">Nothing</span></a>
<a class="sourceLine" id="cb11-4" data-line-number="4">             <span class="ot">-&gt;</span> <span class="dt">Update</span> p b (<span class="dt">PlaceBoard</span> i j p b)</a></code></pre></div>
<p><code>Update</code> is now defined so that, for <code>Update p b1 b2</code>, <code>b2</code> is the update via placement of a piece <code>p</code> at some position in <code>b1</code>, where the placement does not overwrite a previous piece. Note that our <code>MkUpdate</code> constructor only has four “free” variables, <code>i</code>, <code>j</code>, <code>p</code>, and <code>b</code>. If we use <code>MkUpdate</code>, it means that the “final board” is fully determined from only <code>i</code>, <code>j</code>, <code>p</code>, and <code>b</code>.</p>
<h3 id="coord">Coord</h3>
<p>Now we need to define <code>Coord</code>. We’re going to do that in terms of a simpler type that is essentially the same for normal lists — a type:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw">data</span> <span class="dt">Sel</span><span class="ot"> ::</span> <span class="dt">N</span> <span class="ot">-&gt;</span> [k] <span class="ot">-&gt;</span> k <span class="ot">-&gt;</span> <span class="dt">Type</span></a></code></pre></div>
<p>A value of type <code>Sel n xs x</code> says that the nth item in <code>xs</code> is <code>x</code>.</p>
<p>We can define this type inductively, similar to the common <a href="http://hackage.haskell.org/package/type-combinators-0.2.4.3/docs/Data-Type-Index.html"><code>Index</code></a> data type. We can mention our induction rules:</p>
<ol type="1">
<li>The first item in a list as at index 0 (<code>Z</code>)</li>
<li>If an item is at index <code>n</code> in list <code>as</code>, then it is also at index <code>S n</code> in list <code>b ': as</code>.</li>
</ol>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw">data</span> <span class="dt">Sel</span><span class="ot"> ::</span> <span class="dt">N</span> <span class="ot">-&gt;</span> [k] <span class="ot">-&gt;</span> k <span class="ot">-&gt;</span> <span class="dt">Type</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2">    <span class="dt">SelZ</span><span class="ot"> ::</span> <span class="dt">Sel</span> &#39;<span class="dt">Z</span> (a &#39;<span class="fu">:</span> as) a</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">    <span class="dt">SelS</span><span class="ot"> ::</span> <span class="dt">Sel</span> n  as        a <span class="ot">-&gt;</span> <span class="dt">Sel</span> (&#39;<span class="dt">S</span> n) (b &#39;<span class="fu">:</span> bs) a</a></code></pre></div>
<p>For example, for the type-level list <code>'[10,5,2,8]</code>, we can make values:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="dt">SelZ</span><span class="ot">             ::</span> <span class="dt">Sel</span>         &#39;<span class="dt">Z</span>   &#39;[<span class="dv">10</span>,<span class="dv">5</span>,<span class="dv">2</span>,<span class="dv">8</span>] <span class="dv">10</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="dt">SelS</span> <span class="dt">SelZ</span><span class="ot">        ::</span> <span class="dt">Sel</span>     (&#39;<span class="dt">S</span> &#39;<span class="dt">Z</span>)  &#39;[<span class="dv">10</span>,<span class="dv">5</span>,<span class="dv">2</span>,<span class="dv">8</span>] <span class="dv">5</span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="dt">SelS</span> (<span class="dt">SelS</span> <span class="dt">SelZ</span>)<span class="ot"> ::</span> <span class="dt">Sel</span> (&#39;<span class="dt">S</span> (&#39;<span class="dt">S</span> &#39;<span class="dt">Z</span>)) &#39;[<span class="dv">10</span>,<span class="dv">5</span>,<span class="dv">2</span>,<span class="dv">8</span>] <span class="dv">2</span></a></code></pre></div>
<p>etc.</p>
<p>We can then use this to define <code>Coord</code>:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="kw">data</span> <span class="dt">Coord</span><span class="ot"> ::</span> (<span class="dt">N</span>, <span class="dt">N</span>) <span class="ot">-&gt;</span> [[k]] <span class="ot">-&gt;</span> k <span class="ot">-&gt;</span> <span class="dt">Type</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="ot">    (:$:) ::</span> forall i j rows row piece<span class="fu">.</span> ()</a>
<a class="sourceLine" id="cb15-3" data-line-number="3">          <span class="ot">=&gt;</span> <span class="dt">Sel</span> i rows row</a>
<a class="sourceLine" id="cb15-4" data-line-number="4">          <span class="ot">-&gt;</span> <span class="dt">Sel</span> j row  piece</a>
<a class="sourceLine" id="cb15-5" data-line-number="5">          <span class="ot">-&gt;</span> <span class="dt">Coord</span> &#39;(i, j) rows piece</a></code></pre></div>
<p>A <code>Coord '(i, j) rows piece</code> contains a selection into the ith list in <code>rows</code>, to get <code>row</code>, and a selection into the jth item in <code>row</code>, to get <code>piece</code>.</p>
<h3 id="trying-it-out">Trying it out</h3>
<p>That’s it! Let’s see if we can generate some sensible <code>Update</code>s, and maybe even play a sample game.</p>
<p>We’ll start with the <code>EmptyBoard</code>, and let’s add a piece by <code>PX</code> at the middle spot, index (1,1). This means we want <code>SelS SelZ :$: SelS SelZ</code> (a <code>Coord</code> with two indexes into spots 1 and 1) applied to <code>MkUpdate</code>. We’ll use <em>-XTypeApplications</em> to specify the type variables <code>p</code> and <code>b</code>:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb16-1" data-line-number="1">ghci<span class="fu">&gt;</span> <span class="fu">:</span>t <span class="dt">MkUpdate</span> <span class="fu">@</span>_ <span class="fu">@</span>_ <span class="fu">@</span>&#39;<span class="dt">PX</span> <span class="fu">@</span><span class="dt">EmptyBoard</span> (<span class="dt">SelS</span> <span class="dt">SelZ</span> <span class="fu">:$:</span> <span class="dt">SelS</span> <span class="dt">SelZ</span>)</a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="dt">Update</span></a>
<a class="sourceLine" id="cb16-3" data-line-number="3">  &#39;<span class="dt">PX</span></a>
<a class="sourceLine" id="cb16-4" data-line-number="4">  &#39;[ &#39;[ &#39;<span class="dt">Nothing</span>, &#39;<span class="dt">Nothing</span> , &#39;<span class="dt">Nothing</span>],</a>
<a class="sourceLine" id="cb16-5" data-line-number="5">     &#39;[ &#39;<span class="dt">Nothing</span>, &#39;<span class="dt">Nothing</span> , &#39;<span class="dt">Nothing</span>],</a>
<a class="sourceLine" id="cb16-6" data-line-number="6">     &#39;[ &#39;<span class="dt">Nothing</span>, &#39;<span class="dt">Nothing</span> , &#39;<span class="dt">Nothing</span>]</a>
<a class="sourceLine" id="cb16-7" data-line-number="7">   ]</a>
<a class="sourceLine" id="cb16-8" data-line-number="8">  &#39;[ &#39;[ &#39;<span class="dt">Nothing</span>, &#39;<span class="dt">Nothing</span> , &#39;<span class="dt">Nothing</span>],</a>
<a class="sourceLine" id="cb16-9" data-line-number="9">     &#39;[ &#39;<span class="dt">Nothing</span>, &#39;<span class="dt">Just</span> &#39;<span class="dt">PX</span>, &#39;<span class="dt">Nothing</span>],</a>
<a class="sourceLine" id="cb16-10" data-line-number="10">     &#39;[ &#39;<span class="dt">Nothing</span>, &#39;<span class="dt">Nothing</span> , &#39;<span class="dt">Nothing</span>]</a>
<a class="sourceLine" id="cb16-11" data-line-number="11">  ]</a></code></pre></div>
<p>Nice! This update produces exactly he board expected.</p>
<p>Let’s see if we can see if this prevents us from creating an illegal board. We’ll take the result board and see if we can place a <code>PO</code> piece there:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb17-1" data-line-number="1">ghci<span class="fu">&gt;</span> <span class="kw">let</span> <span class="dt">NewBoard</span> <span class="fu">=</span> &#39;[ &#39;[ &#39;<span class="dt">Nothing</span>, &#39;<span class="dt">Nothing</span> , &#39;<span class="dt">Nothing</span> ]</a>
<a class="sourceLine" id="cb17-2" data-line-number="2">                      , &#39;[ &#39;<span class="dt">Nothing</span>, &#39;<span class="dt">Just</span> &#39;<span class="dt">PX</span>, &#39;<span class="dt">Nothing</span> ]</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">                      , &#39;[ &#39;<span class="dt">Nothing</span>, &#39;<span class="dt">Nothing</span> , &#39;<span class="dt">Nothing</span> ]</a>
<a class="sourceLine" id="cb17-4" data-line-number="4">                      ]</a>
<a class="sourceLine" id="cb17-5" data-line-number="5">ghci<span class="fu">&gt;</span> <span class="fu">:</span>k <span class="dt">MkUpdate</span> <span class="fu">@</span>_ <span class="fu">@</span>_ <span class="fu">@</span>&#39;<span class="dt">PO</span> <span class="fu">@</span><span class="dt">NewBoard</span> (<span class="dt">SelS</span> <span class="dt">SelZ</span> <span class="fu">:$:</span> <span class="dt">SelS</span> <span class="dt">SelZ</span>)</a>
<a class="sourceLine" id="cb17-6" data-line-number="6">    • <span class="dt">Couldn&#39;t</span> match <span class="kw">type</span> ‘&#39;<span class="dt">Nothing</span>’ with ‘&#39;<span class="dt">Just</span> &#39;<span class="dt">PX</span>’</a></code></pre></div>
<p>Right! That’s because <code>SelS SelZ :&amp;: SelS SellZ</code>, applied to <code>NewBoard</code>, gives <code>Coord '('S 'Z, 'S 'Z) NewBoard ('Just 'PX)</code>. However, in order to be used with <code>MkUpdate</code>, the final field has to be <code>'Nothing</code>, not <code>'Just 'PX</code>. So, type error.</p>
<p>We can also use this with <code>GameState</code>, using <code>undefined</code> as a placeholder for our <code>InPlay</code> witness, since we haven’t defined it yet:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb18-1" data-line-number="1">ghci<span class="fu">&gt;</span> <span class="fu">:</span>t <span class="dt">GSStart</span></a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="dt">GameState</span></a>
<a class="sourceLine" id="cb18-3" data-line-number="3">    &#39;<span class="dt">PX</span></a>
<a class="sourceLine" id="cb18-4" data-line-number="4">    &#39;[ &#39;[ &#39;<span class="dt">Nothing</span>, &#39;<span class="dt">Nothing</span>, &#39;<span class="dt">Nothing</span>]</a>
<a class="sourceLine" id="cb18-5" data-line-number="5">     , &#39;[ &#39;<span class="dt">Nothing</span>, &#39;<span class="dt">Nothing</span>, &#39;<span class="dt">Nothing</span>]</a>
<a class="sourceLine" id="cb18-6" data-line-number="6">     , &#39;[ &#39;<span class="dt">Nothing</span>, &#39;<span class="dt">Nothing</span>, &#39;<span class="dt">Nothing</span>]</a>
<a class="sourceLine" id="cb18-7" data-line-number="7">     ]</a>
<a class="sourceLine" id="cb18-8" data-line-number="8"></a>
<a class="sourceLine" id="cb18-9" data-line-number="9">ghci<span class="fu">&gt;</span> <span class="kw">let</span> s1 <span class="fu">=</span> <span class="dt">GSUpdate</span> undefined (<span class="dt">MkUpdate</span> (<span class="dt">SelS</span> <span class="dt">SelZ</span> <span class="fu">:$:</span> <span class="dt">SelS</span> <span class="dt">SelZ</span>))</a>
<a class="sourceLine" id="cb18-10" data-line-number="10">             <span class="fu">$</span> <span class="dt">GSStart</span></a>
<a class="sourceLine" id="cb18-11" data-line-number="11">ghci<span class="fu">&gt;</span> <span class="fu">:</span>t s1</a>
<a class="sourceLine" id="cb18-12" data-line-number="12"><span class="dt">GameState</span></a>
<a class="sourceLine" id="cb18-13" data-line-number="13">    &#39;<span class="dt">PO</span>         <span class="co">-- Player switches correclty!</span></a>
<a class="sourceLine" id="cb18-14" data-line-number="14">    &#39;[ &#39;[ &#39;<span class="dt">Nothing</span>, &#39;<span class="dt">Nothing</span> , &#39;<span class="dt">Nothing</span>]</a>
<a class="sourceLine" id="cb18-15" data-line-number="15">     , &#39;[ &#39;<span class="dt">Nothing</span>, &#39;<span class="dt">Just</span> &#39;<span class="dt">PX</span>, &#39;<span class="dt">Nothing</span>]</a>
<a class="sourceLine" id="cb18-16" data-line-number="16">     , &#39;[ &#39;<span class="dt">Nothing</span>, &#39;<span class="dt">Nothing</span> , &#39;<span class="dt">Nothing</span>]</a>
<a class="sourceLine" id="cb18-17" data-line-number="17">     ]</a>
<a class="sourceLine" id="cb18-18" data-line-number="18"></a>
<a class="sourceLine" id="cb18-19" data-line-number="19">ghci<span class="fu">&gt;</span> <span class="kw">let</span> s2 <span class="fu">=</span> <span class="dt">GSUpdate</span> undefined (<span class="dt">MkUpdate</span> (<span class="dt">SelZ</span> <span class="fu">:$:</span> <span class="dt">SelZ</span>))</a>
<a class="sourceLine" id="cb18-20" data-line-number="20">             <span class="fu">$</span> s1</a>
<a class="sourceLine" id="cb18-21" data-line-number="21">ghci<span class="fu">&gt;</span> <span class="fu">:</span>t s2</a>
<a class="sourceLine" id="cb18-22" data-line-number="22"><span class="dt">GameState</span></a>
<a class="sourceLine" id="cb18-23" data-line-number="23">    &#39;<span class="dt">PX</span></a>
<a class="sourceLine" id="cb18-24" data-line-number="24">    &#39;[ &#39;[ &#39;<span class="dt">Just</span> &#39;<span class="dt">PO</span>, &#39;<span class="dt">Nothing</span> , &#39;<span class="dt">Nothing</span>]</a>
<a class="sourceLine" id="cb18-25" data-line-number="25">     , &#39;[ &#39;<span class="dt">Nothing</span> , &#39;<span class="dt">Just</span> &#39;<span class="dt">PX</span>, &#39;<span class="dt">Nothing</span>]</a>
<a class="sourceLine" id="cb18-26" data-line-number="26">     , &#39;[ &#39;<span class="dt">Nothing</span> , &#39;<span class="dt">Nothing</span> , &#39;<span class="dt">Nothing</span>]</a>
<a class="sourceLine" id="cb18-27" data-line-number="27">     ]</a>
<a class="sourceLine" id="cb18-28" data-line-number="28">ghci<span class="fu">&gt;</span> <span class="kw">let</span> s3 <span class="fu">=</span> <span class="dt">GSUpdate</span> undefined (<span class="dt">MkUpdate</span> (<span class="dt">SelZ</span> <span class="fu">:$:</span> <span class="dt">SelZ</span>))</a>
<a class="sourceLine" id="cb18-29" data-line-number="29">             <span class="fu">$</span> s2</a>
<a class="sourceLine" id="cb18-30" data-line-number="30">    • <span class="dt">Couldn&#39;t</span> match <span class="kw">type</span> ‘&#39;<span class="dt">Nothing</span>’ with ‘&#39;<span class="dt">Just</span> &#39;<span class="dt">PO</span>’</a></code></pre></div>
<p>We see that <code>GSUpdate</code> appropriately alternates the player each turn, keeps track of our updated boards, and also cannot be constructed if we give an illegal move (that is, if we try to place a piece where a piece has already been placed). Note that type inference allows us to not have to manually specify the board at each point in time.</p>
<h3 id="creating-updates-from-user-input">Creating Updates from User Input</h3>
<p>Yay!</p></div><footer><hr><div class="copy-content"><p>Hi, thanks for reading! You can reach me via email at <a href="mailto:justin@jle.im">justin@jle.im</a>, or at twitter at <a href="https://twitter.com/mstk">@mstk</a>! This post and all others are published under the <a href="https://creativecommons.org/licenses/by-nc-nd/3.0/">CC-BY-NC-ND 3.0</a> license. Corrections and edits via pull request are welcome and encouraged at <a href="https://github.com/mstksg/inCode">the source repository</a>.</p>
<p>If you feel inclined, or this post was particularly helpful for you, why not consider <a href="https://www.patreon.com/justinle/overview">supporting me on Patreon</a>, or a <a href="bitcoin:3D7rmAYgbDnp4gp4rf22THsGt74fNucPDU">BTC donation</a>? :)</p></div><div class="clear"></div><ul class="entry-series"></ul><ul class="tag-list"><li><a href="https://blog.jle.im/entries/tagged/dependent-types.html" class="tag-a-tag">#dependent types</a></li><li><a href="https://blog.jle.im/entries/tagged/functional-programming.html" class="tag-a-tag">#functional programming</a></li><li><a href="https://blog.jle.im/entries/tagged/haskell.html" class="tag-a-tag">#haskell</a></li><li><a href="https://blog.jle.im/entries/tagged/singletons.html" class="tag-a-tag">#singletons</a></li><li><a href="https://blog.jle.im/entries/tagged/types.html" class="tag-a-tag">#types</a></li><li><a href="https://blog.jle.im/entries/category/@haskell.html" class="tag-a-category">@HASKELL</a></li></ul><aside class="social-buttons"><div class="addthis_toolbox addthis_default_style addthis-buttons"><a class="addthis_button_facebook_like" fb:like:layout="button_count"></a><a class="addthis_button_tweet"></a><a class="addthis_button_google_plusone" g:plusone:size="medium"></a><a class="addthis_counter addthis_pill_style"></a></div><div class="custom-social-buttons"><div class="custom-social-button"><a href="https://www.reddit.com/submit" onclick="window.location = &#39;https://www.reddit.com/submit?url=&#39;+ encodeURIComponent(window.location); return false"><img src="https://www.reddit.com/static/spreddit7.gif" alt="submit to reddit"></a></div></div></aside><nav class="next-prev-links"><ul><li class="next-entry-link">(Next) <a href="https://blog.jle.im/entry/introducing-in-code.html">Introducing &quot;in Code&quot;!</a> &rarr;</li></ul></nav></footer></article><div class="post-entry"><div class="tile"><div id="disqus_thread"></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'https://blog.jle.im/entry/typesafe-tic-tac-toe-1.html';
    this.page.identifier = 'ttt-1';
};
(function() {
    var d = document, s = d.createElement('script');
    s.src = '//incode.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();
</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a><br></noscript><a href="http://disqus.com" class="dsq-brlink">Comments powered by <span class="logo-disqus">Disqus</span></a></div></div></div></div></div><div id="footer-container"><div id="footer-content"><div class="tile"><div class="footer-copyright">&copy; 2018 Justin Le <span class="license-link">(<a href="https://creativecommons.org/licenses/by-nc-nd/3.0/" class="license">CC-BY-NC-ND 3.0</a>)</span></div><div class="footer-follow social-follows"><ul class="social-follows-list"><li><ul class="social-follows-list-social"><li><a class="social-follow-twitter" title="Follow me on Twitter!" href="https://twitter.com/intent/user?user_id=mstk" onclick="window.open(
  &#39;http://twitter.com/intent/user?user_id=907281&#39;,
  &#39;facebook-share-dialog&#39;,
  &#39;width=550,height=520&#39;);
return false;
">Twitter</a></li><li><a class="social-follow-github" title="Fork me on Github!" href="https://github.com/mstksg">Github</a></li><li><a class="social-follow-twitch" title="Watch me on Twitch!" href="https://www.twitch.tv/justin_l">Twitch</a></li><li><a class="social-follow-patreon" title="Support me on Patreon!" href="https://www.patreon.com/justinle/overview">Patreon</a></li><li><a class="social-follow-gplus" title="Add me on Google+!" href="https://plus.google.com/+JustinLe">Google+</a></li><li><a class="social-follow-keybase" title="Track me on Keybase!" href="https://keybase.io/mstksg">Keybase</a></li><li><a class="social-follow-linkedin" title="Connect with me on LinkedIn!" href="https://linkedin.com/in/lejustin">LinkedIn</a></li><li><a class="social-follow-bitcoin" title="Donate via bitcoin!" href="bitcoin:3D7rmAYgbDnp4gp4rf22THsGt74fNucPDU">Bitcoin</a></li></ul></li><li><ul class="social-follows-list-site"><li><a class="social-follow-rss" title="Subscribe to my RSS Feed!" href="http://feeds.feedburner.com/incodeblog">RSS</a></li><li><a class="social-follow-email" title="Subscribe to the mailing list!" href="https://feedburner.google.com/fb/a/mailverify?loc=en_US&amp;uri=incodeblog">Mailing list</a></li></ul></li></ul></div></div></div></div></body></html>